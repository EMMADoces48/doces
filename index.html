<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#667eea">
    <meta name="description" content="Aplicaci√≥n para gestionar asistencias, calificaciones y datos de alumnos">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Registro Escolar">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <title>Registro Escolar</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js" defer></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f2f5;
            padding: 15px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .titulo-principal {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 5px;
            display: inline-block;
            padding: 5px 10px;
            border-radius: 5px;
        }
        
        .subtitulo {
            font-size: 14px;
            opacity: 0.9;
            cursor: pointer;
            display: inline-block;
            padding: 3px 8px;
            border-radius: 5px;
        }
        
        .subtitulo:hover {
            background: rgba(255,255,255,0.1);
        }
        
        .stats {
            padding: 15px 20px;
            background: #e7f3ff;
            border-bottom: 2px solid #b3d9ff;
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
        }
        
        .stat-item {
            font-size: 14px;
        }
        
        .stat-label {
            color: #666;
            margin-right: 5px;
        }
        
        .stat-value {
            font-weight: 700;
            color: #667eea;
        }
        
        .toolbar {
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #333;
        }
        
        .btn-warning:hover {
            background: #e0a800;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
            padding: 6px 12px;
            font-size: 13px;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-small {
            padding: 4px 8px;
            font-size: 11px;
        }
        
        .table-container {
            overflow-x: auto;
            padding: 0;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }
        
        th {
            background: #6c757d;
            color: white;
            padding: 10px 6px;
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        th.nombre-col {
            text-align: left;
            min-width: 120px;
            position: sticky;
            left: 0;
            z-index: 11;
        }
        
        .group-header {
            background: #6c757d !important;
            font-size: 11px;
            position: relative;
        }
        
        .editable {
            cursor: pointer;
            padding: 3px 6px;
            border-radius: 3px;
            display: inline-block;
        }
        
        .editable:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .color-selector {
            display: flex;
            gap: 3px;
            justify-content: center;
            margin-top: 3px;
        }
        
        .color-btn {
            width: 14px;
            height: 14px;
            border: 2px solid #999;
            cursor: pointer;
            border-radius: 2px;
        }
        
        .color-btn:hover {
            transform: scale(1.3);
            border-color: #333;
        }
        
        td {
            padding: 8px 6px;
            border-bottom: 1px solid #e9ecef;
            text-align: center;
            font-size: 13px;
        }
        
        td.nombre-cell {
            text-align: left;
            font-weight: 500;
            background: white;
            position: sticky;
            left: 0;
            z-index: 5;
            border-right: 2px solid #dee2e6;
            cursor: pointer;
            color: #667eea;
            text-decoration: underline;
        }
        
        td.nombre-cell:hover {
            background: #e7f3ff;
            color: #5568d3;
        }
        
        tr:hover td {
            background: #f8f9fa;
        }
        
        tr:hover td.nombre-cell {
            background: #f0f0f0;
        }
        
        .cell-input {
            width: 100%;
            padding: 4px;
            border: 1px solid #ced4da;
            border-radius: 3px;
            text-align: center;
            font-size: 13px;
        }
        
        .cell-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .asistencia-check {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background: white;
            margin: 80px auto;
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .modal-footer {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .close {
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #999;
        }
        
        .close:hover {
            color: #333;
        }
        
        .add-col-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 2px 6px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            margin-left: 5px;
        }
        
        .add-col-btn:hover {
            background: #218838;
        }

        
        /* ========== SISTEMA DE M√öLTIPLES MATERIAS ========== */
        #pantallaInicial {
            position: fixed; top: 0; left: 0; width: 100%; height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex; flex-direction: column; align-items: center;
            justify-content: center; padding: 20px; z-index: 10000;
        }
        #pantallaInicial.oculto { display: none; }
        .logo-principal { font-size: 80px; margin-bottom: 20px;
            animation: flotar 3s ease-in-out infinite; }
        @keyframes flotar { 0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); } }
        .titulo-principal-inicio { color: white; font-size: 32px; font-weight: 700;
            margin-bottom: 10px; text-align: center; cursor: pointer;
            padding: 10px 20px; border-radius: 10px; transition: all 0.3s; }
        .titulo-principal-inicio:hover { background: rgba(255,255,255,0.1); }
        .iconos-escolares { display: flex; gap: 20px; margin-bottom: 30px; font-size: 40px; }
        .caja-materias { background: white; border-radius: 20px; padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-width: 600px; width: 100%;
            max-height: 60vh; overflow-y: auto; }
        .lista-materias { display: flex; flex-direction: column; gap: 10px; }
        .item-materia { padding: 15px 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 10px; cursor: pointer; transition: all 0.3s;
            display: flex; justify-content: space-between; align-items: center;
            border: 2px solid transparent; }
        .item-materia:hover { transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3); border-color: #667eea; }
        .nombre-materia { font-weight: 600; color: #333; font-size: 16px; flex: 1; }
        .info-materia { display: flex; gap: 10px; font-size: 13px; color: #666; align-items: center; }
        .btn-accion-mat { background: #ffc107; border: none; padding: 4px 8px;
            border-radius: 4px; cursor: pointer; font-size: 11px; transition: all 0.2s; }
        .btn-accion-mat:hover { transform: scale(1.1); }
        .btn-accion-mat.eliminar { background: #dc3545; color: white; }
        .btn-nueva-materia { margin-top: 20px; width: 100%; padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; border-radius: 10px; font-size: 16px;
            font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn-nueva-materia:hover { transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
        .firma-nreso { position: absolute; bottom: 15px; right: 20px; font-size: 11px;
            color: rgba(255,255,255,0.7); font-family: 'Courier New', monospace; letter-spacing: 1px; }
        .btn-volver-materias { position: fixed; top: 10px; left: 10px; z-index: 1000;
            padding: 6px 12px; background: white; color: #667eea;
            border: 2px solid #667eea; border-radius: 6px; cursor: pointer;
            font-weight: 600; font-size: 13px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); transition: all 0.3s; }
        .btn-volver-materias:hover { background: #667eea; color: white; }
        .btn-volver-materias.oculto { display: none; }
        #appPrincipal.oculto { display: none; }
        
        /* ========== PANTALLA DE ESCUELAS ========== */
        #pantallaEscuelas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex; flex-direction: column; align-items: center;
            justify-content: center; z-index: 2000; overflow-y: auto; padding: 20px;
        }
        #pantallaEscuelas.oculto { display: none; }
        
        .logo-doces {
            text-align: center;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .logo-doces img {
            max-width: 500px;
            width: 90%;
            height: auto;
            filter: drop-shadow(0 4px 20px rgba(0,0,0,0.2));
        }
        
        .subtitulo-escuelas {
            color: rgba(255,255,255,0.9);
            font-size: 18px;
            margin-bottom: 10px;
            font-weight: 300;
        }
        
        .texto-escuelas-fijo {
            color: rgba(255,255,255,0.7);
            font-size: 11px;
            margin-bottom: 40px;
            font-weight: 400;
            letter-spacing: 0.5px;
            user-select: none;
            pointer-events: none;
        }
        
        .contenedor-escuelas {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        
        .lista-escuelas {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .escuela-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .escuela-item:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .escuela-nombre {
            flex: 1;
            font-size: 18px;
            font-weight: 600;
            color: #333;
            border: none;
            background: transparent;
            outline: none;
        }
        
        .escuela-nombre:focus {
            color: #667eea;
        }
        
        .btn-editar-escuela {
            padding: 8px 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 10px;
            transition: all 0.3s;
        }
        
        .btn-editar-escuela:hover {
            background: #5568d3;
        }
        
        .btn-eliminar-escuela {
            padding: 8px 15px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 10px;
            transition: all 0.3s;
        }
        
        .btn-eliminar-escuela:hover {
            background: #c82333;
        }
        
        .btn-agregar-escuela {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-agregar-escuela:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-agregar-escuela:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .sin-escuelas {
            text-align: center;
            color: #999;
            padding: 40px 20px;
            font-style: italic;
        }
        
        .limite-escuelas {
            text-align: center;
            color: #666;
            font-size: 13px;
            margin-top: 10px;
        }
        
        /* ========== PANTALLA DE CONTRASE√ëA ========== */
        #pantallaPassword {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 99999;
        }
        
        #pantallaPassword.oculto {
            display: none;
        }
        
        .password-container {
            background: white;
            border-radius: 20px;
            padding: 40px 30px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            text-align: center;
        }
        
        .password-logo {
            margin-bottom: 20px;
        }
        
        .password-logo img {
            max-width: 300px;
            width: 80%;
            height: auto;
        }
        
        .password-title {
            font-size: 18px;
            color: #333;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .password-subtitle {
            font-size: 14px;
            color: #666;
            margin-bottom: 25px;
        }
        
        .password-input-container {
            position: relative;
            margin-bottom: 20px;
        }
        
        .password-input {
            width: 100%;
            padding: 15px 45px 15px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
            box-sizing: border-box;
        }
        
        .password-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .password-toggle {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
        }
        
        .password-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .password-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .password-btn:active {
            transform: translateY(0);
        }
        
        .password-error {
            color: #dc3545;
            font-size: 14px;
            margin-top: 10px;
            display: none;
        }
        
        .password-error.mostrar {
            display: block;
            animation: shake 0.5s;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        /* ========== BOT√ìN HORARIOS ========== */
        .btn-horarios { width:100%; padding:12px; margin-top:12px; background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%); color:white; border:none; border-radius:10px; font-size:15px; font-weight:600; cursor:pointer; transition:all 0.3s; }
        .btn-horarios:hover { transform:translateY(-2px); }

        #pantallaHorarios { position:fixed; top:0; left:0; width:100%; height:100vh; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); display:flex; flex-direction:column; align-items:center; z-index:3000; overflow-y:auto; padding:20px; }
        #pantallaHorarios.oculto { display:none; }
        .horarios-header { width:100%; max-width:700px; display:flex; align-items:center; margin-bottom:20px; gap:15px; }
        .btn-volver-horarios { padding:8px 16px; background:white; color:#667eea; border:2px solid white; border-radius:8px; cursor:pointer; font-weight:600; font-size:13px; }
        .horarios-titulo { color:white; font-size:22px; font-weight:700; }
        .contenedor-horarios { background:white; border-radius:15px; padding:25px; max-width:700px; width:95%; box-shadow:0 10px 40px rgba(0,0,0,0.3); }
        .lista-horarios { display:flex; flex-direction:column; gap:10px; margin-bottom:15px; }
        .horario-item { background:#f8f9fa; padding:15px 20px; border-radius:10px; border:2px solid #e0e0e0; cursor:pointer; display:flex; justify-content:space-between; align-items:center; transition:all 0.3s; }
        .horario-item:hover { border-color:#f093fb; transform:translateY(-2px); }
        .horario-item-nombre { font-size:16px; font-weight:600; color:#333; }
        .horario-item-acciones { display:flex; gap:8px; }
        .btn-editar-horario { padding:6px 12px; background:#667eea; color:white; border:none; border-radius:6px; cursor:pointer; }
        .btn-eliminar-horario { padding:6px 12px; background:#dc3545; color:white; border:none; border-radius:6px; cursor:pointer; }
        .btn-agregar-horario { width:100%; padding:15px; background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%); color:white; border:none; border-radius:10px; font-size:16px; font-weight:600; cursor:pointer; transition:all 0.3s; }
        .sin-horarios { text-align:center; color:#999; padding:30px 20px; font-style:italic; }

        #pantallaTablaHorario { position:fixed; top:0; left:0; width:100%; height:100vh; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); display:flex; flex-direction:column; align-items:center; z-index:4000; overflow-y:auto; padding:20px; }
        #pantallaTablaHorario.oculto { display:none; }
        .tabla-horario-header { width:100%; max-width:900px; display:flex; align-items:center; margin-bottom:20px; gap:15px; }
        .contenedor-tabla-horario { background:white; border-radius:15px; padding:20px; max-width:900px; width:98%; box-shadow:0 10px 40px rgba(0,0,0,0.3); overflow-x:auto; }
        .tabla-horario { width:100%; border-collapse:collapse; min-width:550px; }
        .tabla-horario th { background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:white; padding:10px 8px; text-align:center; font-size:13px; font-weight:600; border:1px solid #5568d3; }
        .th-input { background:transparent; border:none; color:white; font-size:13px; font-weight:600; text-align:center; width:100%; outline:none; cursor:pointer; font-family:inherit; }
        .th-input:focus { border-bottom:2px solid rgba(255,255,255,0.8); cursor:text; }
        .th-input::placeholder { color:rgba(255,255,255,0.6); }
        .hora-input { color:#555; font-size:12px; width:100%; min-height:70px; padding:4px; border:none; resize:none; background:transparent; outline:none; font-family:inherit; font-weight:600; text-align:center; box-sizing:border-box; }
        .hora-input:focus { background:#e8eeff; }
        .btn-add-row, .btn-add-col { background:rgba(255,255,255,0.18); color:white; border:2px solid rgba(255,255,255,0.5); border-radius:50%; cursor:pointer; font-size:18px; font-weight:700; line-height:1; transition:all 0.2s; width:32px; height:32px; display:flex; align-items:center; justify-content:center; padding:0; }
        .btn-add-row { border-radius:8px; width:100%; height:32px; margin-top:6px; font-size:16px; }
        .btn-add-row:hover, .btn-add-col:hover { background:rgba(255,255,255,0.4); border-color:white; transform:scale(1.1); }
        .btn-del-row { background:transparent; border:none; color:#ffaaaa; cursor:pointer; font-size:16px; padding:2px 4px; line-height:1; }
        .btn-del-row:hover { color:#ff4444; }
        .tabla-horario td { border:1px solid #dee2e6; padding:2px; vertical-align:top; min-width:80px; }
        .tabla-horario td.hora-cell { background:#f0f4ff; font-weight:600; font-size:12px; color:#555; text-align:center; padding:4px; min-width:90px; width:90px; position:sticky; left:0; z-index:2; }
        .tabla-horario th { position:relative; z-index:1; }
        .tabla-horario th:first-child { position:sticky; left:0; z-index:10; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); }
        .celda-horario { width:100%; min-height:50px; padding:5px; border:none; resize:none; font-size:12px; font-family:inherit; background:transparent; outline:none; box-sizing:border-box; }
        .celda-horario:focus { background:#f0f8ff; }

    </style>
    <script>
        var PASSWORD_CORRECTA = 'DOCES';
        var PASSWORD_SESSION_KEY = 'doces_password_ok';

        function verificarPassword() {
            var input = document.getElementById('inputPassword');
            var password = input.value.trim().toUpperCase();
            var errorDiv = document.getElementById('passwordError');
            if (password === PASSWORD_CORRECTA) {
                sessionStorage.setItem(PASSWORD_SESSION_KEY, 'true');
                document.getElementById('pantallaPassword').style.display = 'none';
                document.getElementById('pantallaEscuelas').style.display = 'flex';
                errorDiv.classList.remove('mostrar');
            } else {
                errorDiv.classList.add('mostrar');
                input.value = '';
                input.focus();
                if (navigator.vibrate) navigator.vibrate(200);
            }
        }

        function togglePasswordVisibility() {
            var input = document.getElementById('inputPassword');
            input.type = (input.type === 'password') ? 'text' : 'password';
        }

        document.addEventListener('DOMContentLoaded', function() {
            if (sessionStorage.getItem(PASSWORD_SESSION_KEY) === 'true') {
                document.getElementById('pantallaPassword').style.display = 'none';
                document.getElementById('pantallaEscuelas').style.display = 'flex';
            }
            var inp = document.getElementById('inputPassword');
            if (inp) inp.addEventListener('keypress', function(e){ if(e.key==='Enter') verificarPassword(); });
        });
    </script>
</head>
<body>

    <!-- PANTALLA DE CONTRASE√ëA -->
    <div id="pantallaPassword">
        <div class="password-container">
            <div class="password-logo">
                <img src="logo-doces.png" alt="DocES">
            </div>
            <h2 class="password-title">üîê Acceso Protegido</h2>
            <p class="password-subtitle">Ingres√° la contrase√±a para continuar</p>
            
            <div class="password-input-container">
                <input 
                    type="password" 
                    id="inputPassword" 
                    class="password-input" 
                    placeholder="Contrase√±a"
                    autocomplete="off"
                >
                <button class="password-toggle" onclick="togglePasswordVisibility()" title="Mostrar/Ocultar">üëÅÔ∏è</button>
            </div>
            
            <button class="password-btn" onclick="verificarPassword()">INGRESAR</button>
            
            <div class="password-error" id="passwordError">‚ùå Contrase√±a incorrecta</div>
        </div>
    </div>

    <!-- PANTALLA DE ESCUELAS (Nueva) -->
    <div id="pantallaEscuelas" class="oculto">
        <div class="logo-doces">
            <img src="logo-doces.png" alt="DocES" style="max-width: 500px; width: 90%; height: auto;">
        </div>
        <div class="subtitulo-escuelas">agenda escolar</div>
        <div class="texto-escuelas-fijo">NRESO N¬∞2048 / ESC N¬∞48 / NRESO N¬∞1048</div>
        
        <div class="contenedor-escuelas">
            <div class="lista-escuelas" id="listaEscuelas">
                <!-- Las escuelas se cargan din√°micamente -->
            </div>
            <button class="btn-agregar-escuela" id="btnAgregarEscuela" onclick="ESC_agregarEscuela()">‚ûï AGREGAR ESCUELA</button>
            <div class="limite-escuelas" id="limiteEscuelas">0 de 7 escuelas</div>
            <button class="btn-horarios" onclick="HOR_mostrarPantalla()">üìÖ HORARIOS</button>
        </div>
        
        <div style="margin-top: 15px; text-align: center;">
            <a href="mailto:emmanuelquiroga13@gmail.com" style="color: rgba(255,255,255,0.6); font-size: 11px; text-decoration: none; letter-spacing: 0.5px;">
                SUGERENCIAS: emmanuelquiroga13@gmail.com
            </a>
        </div>
    </div>

    <!-- PANTALLA DE HORARIOS -->
    <div id="pantallaHorarios" class="oculto">
        <div class="horarios-header">
            <button class="btn-volver-horarios" onclick="HOR_volverAEscuelas()">‚Üê Volver</button>
            <div class="horarios-titulo">üìÖ HORARIOS</div>
        </div>
        <div class="contenedor-horarios">
            <div class="lista-horarios" id="listaHorarios">
                <div class="sin-horarios">No hay horarios. Agreg√° uno nuevo.</div>
            </div>
            <button class="btn-agregar-horario" onclick="HOR_agregar()">‚ûï AGREGAR HORARIO POR ESCUELA</button>
        </div>
    </div>

    <!-- PANTALLA DE TABLA DE HORARIO -->
    <div id="pantallaTablaHorario" class="oculto">
        <div class="tabla-horario-header">
            <button class="btn-volver-horarios" onclick="HOR_volverALista()">‚Üê Volver</button>
            <div class="horarios-titulo" id="tituloTablaHorario">Horario</div>
        </div>
        <div class="contenedor-tabla-horario">
            <table class="tabla-horario">
                <thead id="theadTablaHorario"></thead>
                <tbody id="tbodyTablaHorario"></tbody>
            </table>
        </div>
    </div>

    <!-- PANTALLA INICIAL: Selector de Materias -->
    <div id="pantallaInicial" class="oculto">
        <button class="btn-volver-materias" onclick="ESC_volverAEscuelas()" style="position: absolute; top: 20px; left: 20px; z-index: 100;">‚Üê Volver a Escuelas</button>
        <div class="logo-principal">üìö</div>
        <h1 class="titulo-principal-inicio" id="tituloPantallaInicio">SELECCIONA TU MATERIA</h1>
        <div class="iconos-escolares">
            <span>üìì</span><span>‚úèÔ∏è</span><span>üìê</span><span>üéí</span>
        </div>
        <div class="caja-materias">
            <div class="lista-materias" id="listaMateriasInicio"></div>
            <button class="btn-nueva-materia" onclick="MM_nuevaMateria()">‚ûï Nueva Materia</button>
        </div>
    </div>
    
    <button class="btn-volver-materias oculto" id="btnVolverMaterias" onclick="MM_volverAInicio()">‚Üê Volver a Materias</button>
    
    <div class="container oculto" id="appPrincipal">
        <header>
            <div class="titulo-principal" id="titulo">üìö Registro Escolar</div>
            <div class="subtitulo" id="subtitulo" onclick="editarSubtitulo()">Construcci√≥n (3¬∞) - Eco</div>
        </header>
        
        <div class="stats">
            <div class="stat-item">
                <span class="stat-label">Total de alumnos:</span>
                <span class="stat-value" id="totalAlumnos">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">√öltima actualizaci√≥n:</span>
                <span class="stat-value" id="ultimaActualizacion">-</span>
            </div>
        </div>
        
        <div class="toolbar">
            <button class="btn btn-primary" onclick="mostrarModalAlumno()">‚ûï Agregar Alumno</button>
            <button class="btn btn-success" onclick="exportarPDF()">üìÑ Exportar PDF</button>
            <button class="btn" onclick="deshacer()" id="btnDeshacer" style="background: #6c757d; color: white;" disabled>‚Ü∂ Deshacer</button>
            <button class="btn btn-primary" onclick="descargarRespaldo()">üì• Descargar Respaldo</button>
            <button class="btn btn-warning" onclick="document.getElementById('fileInput').click()">üì§ Cargar Respaldo</button>
            <button class="btn" onclick="CAL_abrir()" style="background: #e74c3c; color: white;">üìÖ Calendario</button>
            <input type="file" id="fileInput" accept=".json" style="display:none" onchange="cargarRespaldo(event)">
        </div>
        
        <div class="table-container">
            <table>
                <thead id="theadTabla"></thead>
                <tbody id="tbodyTabla"></tbody>
            </table>
        </div>
    </div>
    
    <!-- Modal Alumno -->
    <div id="modalAlumno" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModal('modalAlumno')">&times;</span>
            <div class="modal-header">Agregar Nuevo Alumno</div>
            <div class="form-group">
                <label>Nombre y Apellido:</label>
                <input type="text" id="inputAlumno" placeholder="Ej: Juan P√©rez">
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="agregarAlumno()">Agregar</button>
                <button class="btn" onclick="cerrarModal('modalAlumno')" style="background: #6c757d; color: white;">Cancelar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal Columna -->
    <div id="modalColumna" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModal('modalColumna')">&times;</span>
            <div class="modal-header">Agregar Nueva Columna</div>
            <div class="form-group">
                <label>Grupo:</label>
                <select id="selectGrupo" onchange="actualizarPlaceholderColumna()">
                    <option value="asist">Asistencias (con fecha autom√°tica)</option>
                    <option value="trab">Trabajos/Eval.</option>
                    <option value="trim">Trimestres</option>
                    <option value="cal">Calificaciones</option>
                    <option value="otro">Otros</option>
                </select>
            </div>
            <div class="form-group" id="nombreColumnaGroup">
                <label>Nombre de la columna:</label>
                <input type="text" id="inputColumna" placeholder="Se agregar√° con la fecha de hoy">
                <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">
                    üí° Para columnas de Asistencia, la fecha se asigna autom√°ticamente. Puedes cambiarla despu√©s haciendo clic en üìÖ
                </small>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="agregarColumna()">Agregar</button>
                <button class="btn" onclick="cerrarModal('modalColumna')" style="background: #6c757d; color: white;">Cancelar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal Editar -->
    <div id="modalEditar" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModal('modalEditar')">&times;</span>
            <div class="modal-header">Editar Texto</div>
            <div class="form-group">
                <label>Nuevo texto:</label>
                <input type="text" id="inputEditar">
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="guardarEdicion()">Guardar</button>
                <button class="btn" onclick="cerrarModal('modalEditar')" style="background: #6c757d; color: white;">Cancelar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal Selector de Fecha -->
    <div id="modalFecha" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <span class="close" onclick="cerrarModal('modalFecha')">&times;</span>
            <div class="modal-header">üìÖ Seleccionar Fecha</div>
            <div class="form-group">
                <label>Fecha:</label>
                <input type="date" id="inputFecha" style="width: 100%; padding: 10px; font-size: 16px;">
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="guardarFecha()">Guardar</button>
                <button class="btn" onclick="cerrarModal('modalFecha')" style="background: #6c757d; color: white;">Cancelar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal Ficha del Alumno -->
    <div id="modalFichaAlumno" class="modal">
        <div class="modal-content" style="max-width: 600px; max-height: 85vh; overflow-y: auto;">
            <span class="close" onclick="cerrarModal('modalFichaAlumno')">&times;</span>
            <div class="modal-header" id="nombreAlumnoFicha" style="font-size: 18px; margin-bottom: 15px;">Ficha del Alumno</div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div class="form-group" style="margin-bottom: 10px;">
                    <label style="font-size: 13px;">üë§ Nombre:</label>
                    <input type="text" id="fichaNombreCompleto" placeholder="Juan P√©rez" style="padding: 8px; font-size: 13px;" oninput="autoGuardarFicha()">
                </div>
                
                <div class="form-group" style="margin-bottom: 10px;">
                    <label style="font-size: 13px;">üìß Email:</label>
                    <input type="email" id="fichaEmail" placeholder="ejemplo@email.com" style="padding: 8px; font-size: 13px;" oninput="autoGuardarFicha()">
                </div>
                
                <div class="form-group" style="margin-bottom: 10px;">
                    <label style="font-size: 13px;">üì± Tel√©fono:</label>
                    <input type="tel" id="fichaTelefono" placeholder="+54 9 11 1234-5678" style="padding: 8px; font-size: 13px;" oninput="autoGuardarFicha()">
                </div>
                
                <div class="form-group" style="margin-bottom: 10px;">
                    <label style="font-size: 13px;">üéÇ F. Nacimiento:</label>
                    <input type="date" id="fichaNacimiento" style="padding: 8px; font-size: 13px;" oninput="autoGuardarFicha()">
                </div>
            </div>
            
            <div class="form-group" style="margin-bottom: 10px;">
                <label style="font-size: 13px;">üìç Direcci√≥n:</label>
                <input type="text" id="fichaDireccion" placeholder="Calle, N√∫mero, Ciudad" style="padding: 8px; font-size: 13px;" oninput="autoGuardarFicha()">
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div class="form-group" style="margin-bottom: 10px;">
                    <label style="font-size: 13px;">üë®‚Äçüë©‚Äçüëß Contacto Emergencia:</label>
                    <input type="text" id="fichaContactoNombre" placeholder="Nombre del tutor" style="padding: 8px; font-size: 13px;" oninput="autoGuardarFicha()">
                </div>
                
                <div class="form-group" style="margin-bottom: 10px;">
                    <label style="font-size: 13px;">üìû Tel. Emergencia:</label>
                    <input type="tel" id="fichaContactoTelefono" placeholder="+54 9 11 1234-5678" style="padding: 8px; font-size: 13px;" oninput="autoGuardarFicha()">
                </div>
            </div>
            
            <div class="form-group" style="margin-bottom: 10px;">
                <label style="font-size: 13px;">üìù Notas:</label>
                <textarea id="fichaNotas" rows="3" style="width: 100%; padding: 8px; border: 2px solid #ced4da; border-radius: 6px; font-size: 13px; font-family: inherit;" placeholder="Alergias, medicamentos, observaciones..." oninput="autoGuardarFicha()"></textarea>
            </div>
            
            <div style="text-align: center; margin-top: 15px; padding: 10px; background: #e7f3ff; border-radius: 6px; font-size: 12px; color: #666;">
                ‚úÖ Los cambios se guardan autom√°ticamente
            </div>
            
            <div class="modal-footer" style="margin-top: 15px;">
                <button class="btn btn-primary" onclick="cerrarModal('modalFichaAlumno')">‚úì Cerrar</button>
            </div>
        </div>
    </div>
    
    
    <!-- Modal Calendario -->
    <div id="modalCalendario" class="modal">
        <div class="modal-content" style="max-width:520px; max-height:90vh; overflow-y:auto; position:relative; padding-top:20px;">
            <span class="close" onclick="cerrarModal('modalCalendario')" style="position:absolute; right:15px; top:10px;">&times;</span>
            <div class="modal-header" style="display:flex; justify-content:center; align-items:center; gap:10px; padding-top:10px; margin-right:30px;">
                <button onclick="CAL_mesAnterior()" style="background:none;border:none;font-size:20px;cursor:pointer;">‚Äπ</button>
                <span id="calTituloMes" style="font-size:17px;font-weight:700;"></span>
                <button onclick="CAL_mesSiguiente()" style="background:none;border:none;font-size:20px;cursor:pointer;">‚Ä∫</button>
            </div>
            <div id="calGrid" style="margin-top:10px;"></div>
            <!-- Panel de anotaci√≥n -->
            <div id="calPanelDia" style="display:none; margin-top:15px; padding:15px; background:#fff5f5; border-radius:10px; border:2px solid #e74c3c;">
                <div style="font-weight:700; color:#e74c3c; margin-bottom:8px;" id="calDiaSeleccionado"></div>
                <div id="calListaEventos" style="margin-bottom:10px;"></div>
                <div style="display:flex; gap:8px;">
                    <input type="text" id="calInputEvento" placeholder="Ej: Evaluaci√≥n, Trabajo pr√°ctico..." style="flex:1; padding:8px; border:1px solid #ddd; border-radius:6px; font-size:13px;">
                    <button onclick="CAL_agregarEvento()" style="padding:8px 14px; background:#e74c3c; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:600;">Ôºã</button>
                </div>
            </div>
        </div>
    </div>

    <style>
        .cal-grid { display:grid; grid-template-columns:repeat(7,1fr); gap:4px; }
        .cal-dia-nombre { text-align:center; font-size:11px; font-weight:700; color:#888; padding:4px 0; }
        .cal-dia { text-align:center; padding:6px 2px; border-radius:50%; cursor:pointer; font-size:13px; position:relative; min-height:34px; display:flex; align-items:center; justify-content:center; }
        .cal-dia:hover { background:#f0f0f0; }
        .cal-dia.vacio { cursor:default; }
        .cal-dia.marcado { background:#e74c3c !important; color:white !important; font-weight:700; border-radius:50%; }
        .cal-dia.seleccionado { outline:3px solid #e74c3c; border-radius:50%; }
        .cal-dia.hoy { font-weight:700; color:#667eea; }
        .cal-evento-item { display:flex; justify-content:space-between; align-items:center; padding:5px 8px; margin-bottom:4px; background:white; border-radius:6px; border:1px solid #fbb; font-size:13px; }
        .cal-evento-item button { background:none; border:none; color:#e74c3c; cursor:pointer; font-size:15px; padding:0 4px; }
    </style>

    <!-- Modal Informe IA -->
    <div id="modalInformeIA" class="modal">
        <div class="modal-content" style="max-width:600px; max-height:90vh; overflow-y:auto; position:relative;">
            <span class="close" onclick="cerrarModal('modalInformeIA')" style="position:absolute;right:15px;top:10px;">&times;</span>
            <div class="modal-header" style="padding-right:30px;">ü§ñ Informe por IA</div>
            <div id="iaAlumnoNombre" style="font-size:15px;color:#667eea;font-weight:600;margin-bottom:15px;"></div>
            <div id="iaContenido" style="min-height:120px;">
                <div id="iaLoading" style="display:none;text-align:center;padding:30px;color:#667eea;">
                    <div style="font-size:30px;margin-bottom:10px;">‚è≥</div>
                    <div>Generando informe...</div>
                </div>
                <div id="iaTexto" style="white-space:pre-wrap;line-height:1.7;font-size:14px;color:#333;"></div>
            </div>
            <div class="modal-footer" style="margin-top:15px;">
                <button class="btn btn-primary" onclick="IA_copiar()">üìã Copiar informe</button>
                <button class="btn" onclick="cerrarModal('modalInformeIA')" style="background:#6c757d;color:white;">Cerrar</button>
            </div>
        </div>
    </div>

    <style>
        .btn-ia { background:linear-gradient(135deg,#667eea,#764ba2); color:white; border:none; padding:5px 10px; border-radius:6px; cursor:pointer; font-size:12px; font-weight:600; white-space:nowrap; transition:all 0.2s; }
        .btn-ia:hover { opacity:0.85; transform:scale(1.05); }
        .btn-ia:disabled { opacity:0.5; cursor:wait; }
    </style>

    <script>
        // Configuraci√≥n de Google Drive
        const CLIENT_ID = 'TU_CLIENT_ID_AQUI'; // El usuario deber√° configurar esto
        const API_KEY = 'TU_API_KEY_AQUI'; // El usuario deber√° configurar esto
        const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        
        let gapiInited = false;
        let gisInited = false;
        let tokenClient;
        let accessToken = null;
        let driveFileId = null;
        
        // ========== SISTEMA DE ESCUELAS ==========
        let ESC = {
            db: {
                escuelas: {}
            },
            activa: null,
            MAX_ESCUELAS: 7
        };
        
        // Cargar base de datos de escuelas
        function ESC_cargarDB() {
            const data = localStorage.getItem('doces_escuelas_db');
            if (data) {
                try {
                    ESC.db = JSON.parse(data);
                } catch(e) {
                    ESC.db = { escuelas: {} };
                }
            }
        }
        
        // Guardar base de datos de escuelas
        function ESC_guardarDB() {
            localStorage.setItem('doces_escuelas_db', JSON.stringify(ESC.db));
        }
        
        // Renderizar lista de escuelas
        function ESC_renderizar() {
            const lista = document.getElementById('listaEscuelas');
            const btn = document.getElementById('btnAgregarEscuela');
            const limite = document.getElementById('limiteEscuelas');
            
            const escuelas = Object.values(ESC.db.escuelas);
            const total = escuelas.length;
            
            if (total === 0) {
                lista.innerHTML = '<div class="sin-escuelas">No hay escuelas agregadas.<br>Toca "AGREGAR ESCUELA" para comenzar.</div>';
            } else {
                let html = '';
                escuelas.forEach(esc => {
                    html += `
                        <div class="escuela-item" onclick="ESC_abrirEscuela('${esc.id}')">
                            <div class="escuela-nombre">${esc.nombre}</div>
                            <button class="btn-editar-escuela" onclick="event.stopPropagation(); ESC_editarNombre('${esc.id}')">‚úèÔ∏è</button>
                            <button class="btn-eliminar-escuela" onclick="event.stopPropagation(); ESC_eliminarEscuela('${esc.id}')">üóëÔ∏è</button>
                        </div>
                    `;
                });
                lista.innerHTML = html;
            }
            
            // Actualizar bot√≥n y l√≠mite
            limite.textContent = `${total} de ${ESC.MAX_ESCUELAS} escuelas`;
            if (total >= ESC.MAX_ESCUELAS) {
                btn.disabled = true;
                btn.textContent = '‚úì L√çMITE ALCANZADO (7/7)';
            } else {
                btn.disabled = false;
                btn.textContent = '‚ûï AGREGAR ESCUELA';
            }
        }
        
        // Agregar nueva escuela
        function ESC_agregarEscuela() {
            const total = Object.keys(ESC.db.escuelas).length;
            if (total >= ESC.MAX_ESCUELAS) {
                alert('‚ö†Ô∏è L√≠mite alcanzado\n\nSolo puedes tener hasta ' + ESC.MAX_ESCUELAS + ' escuelas.');
                return;
            }
            
            const nombre = prompt('Nombre de la escuela:', 'Escuela ' + (total + 1));
            if (!nombre || nombre.trim() === '') return;
            
            const id = 'esc_' + Date.now();
            ESC.db.escuelas[id] = {
                id: id,
                nombre: nombre.trim(),
                materias: {}
            };
            
            ESC_guardarDB();
            ESC_renderizar();
        }
        
        // Editar nombre de escuela
        function ESC_editarNombre(id) {
            const esc = ESC.db.escuelas[id];
            if (!esc) return;
            
            const nuevoNombre = prompt('Nuevo nombre de la escuela:', esc.nombre);
            if (!nuevoNombre || nuevoNombre.trim() === '') return;
            
            esc.nombre = nuevoNombre.trim();
            ESC_guardarDB();
            ESC_renderizar();
        }
        
        // Eliminar escuela
        function ESC_eliminarEscuela(id) {
            const esc = ESC.db.escuelas[id];
            if (!esc) return;
            
            const totalMaterias = Object.keys(esc.materias || {}).length;
            const msg = `¬øEliminar "${esc.nombre}"?\n\n` +
                       (totalMaterias > 0 
                        ? `Esta escuela tiene ${totalMaterias} materia(s).\n\n`
                        : '') +
                       'Esta acci√≥n NO se puede deshacer.';
            
            if (!confirm(msg)) return;
            
            delete ESC.db.escuelas[id];
            ESC_guardarDB();
            ESC_renderizar();
        }
        
        // Abrir escuela (ir a pantalla de materias)
        function ESC_abrirEscuela(id) {
            const esc = ESC.db.escuelas[id];
            if (!esc) return;

            ESC.activa = id;

            if (!esc.materias) esc.materias = {};
            MM.db.materias = esc.materias;

            document.getElementById('pantallaEscuelas').style.display = 'none';

            document.getElementById('tituloPantallaInicio').textContent = esc.nombre.toUpperCase();

            MM_mostrarInicio();
        }
        
        // Volver a pantalla de escuelas
        function ESC_volverAEscuelas() {
            if (ESC.activa && ESC.db.escuelas[ESC.activa]) {
                ESC.db.escuelas[ESC.activa].materias = MM.db.materias;
                ESC_guardarDB();
            }

            ESC.activa = null;

            document.getElementById('pantallaInicial').style.display = 'none';
            document.getElementById('appPrincipal').style.display = 'none';
            document.getElementById('btnVolverMaterias').style.display = 'none';

            const pe = document.getElementById('pantallaEscuelas');
            pe.classList.remove('oculto');
            pe.style.display = 'flex';

            ESC_renderizar();
        }
        
        let config = {
            titulo: 'üìö Registro Escolar',
            subtitulo: 'Construcci√≥n (3¬∞) - Eco',
            labelNombre: 'Nombre y Apellido',
            labelAsistencias: 'Asistencias',
            labelTrabajos: 'Trabajos/Eval.',
            labelTrimestres: 'Trimestres',
            labelCalificaciones: 'Calificaciones',
            labelOtros: 'Otros',
            cols: [
                {id:'a1', nom: new Date().toLocaleDateString('es-AR', {day: '2-digit', month: '2-digit'}), tipo:'asist', color:'white'},
                {id:'tp1', nom:'TP/Eval', tipo:'trab', color:'white'},
                {id:'t1', nom:'1¬∞', tipo:'trim', color:'white'},
                {id:'cal1', nom:'CF', tipo:'cal', color:'white'},
                {id:'otro1', nom:'Otro1', tipo:'otro', color:'white'}
            ]
        };
        
        let alumnos = [];
        let editando = null;
        let historial = [];
        const MAX_HISTORIAL = 20;
        
        // Inicializar
        window.onload = () => {
            cargar();
            render();
        };
        
        function cargar() {
            const c = localStorage.getItem('config');
            const a = localStorage.getItem('alumnos');
            const h = localStorage.getItem('historial');
            
            if (c) config = JSON.parse(c);
            if (a) alumnos = JSON.parse(a);
            if (h) historial = JSON.parse(h);
            
            document.getElementById('titulo').textContent = config.titulo;
            document.getElementById('subtitulo').textContent = config.subtitulo;
            document.getElementById('btnDeshacer').disabled = historial.length === 0;
        }
        
        function guardar() {
            localStorage.setItem('config', JSON.stringify(config));
            localStorage.setItem('alumnos', JSON.stringify(alumnos));
            localStorage.setItem('historial', JSON.stringify(historial));
            localStorage.setItem('fecha', new Date().toLocaleString());
            document.getElementById('totalAlumnos').textContent = alumnos.length;
            document.getElementById('ultimaActualizacion').textContent = localStorage.getItem('fecha') || '-';
            document.getElementById('btnDeshacer').disabled = historial.length === 0;
        }
        
        function guardarConHistorial() {
            // Guardar snapshot en historial ANTES de hacer cambios
            historial.push({
                config: JSON.parse(JSON.stringify(config)),
                alumnos: JSON.parse(JSON.stringify(alumnos))
            });
            
            if (historial.length > MAX_HISTORIAL) {
                historial.shift();
            }
            
            guardar();
        }
        
        function render() {
            renderHeader();
            renderBody();
            document.getElementById('totalAlumnos').textContent = alumnos.length;
            document.getElementById('ultimaActualizacion').textContent = localStorage.getItem('fecha') || '-';
        }
        
        function renderHeader() {
            const thead = document.getElementById('theadTabla');
            const asist = config.cols.filter(c => c.tipo === 'asist');
            const trab = config.cols.filter(c => c.tipo === 'trab');
            const trim = config.cols.filter(c => c.tipo === 'trim');
            const cal = config.cols.filter(c => c.tipo === 'cal');
            const otros = config.cols.filter(c => c.tipo === 'otro');
            
            let html = '<tr>';
            html += `<th class="nombre-col"><span class="editable" onclick="editarLabel('labelNombre')">${config.labelNombre}</span></th>`;
            if (asist.length) html += `<th colspan="${asist.length}" class="group-header"><span class="editable" onclick="editarLabel('labelAsistencias')">${config.labelAsistencias}</span> <button class="add-col-btn" onclick="mostrarModalColumnaRapida('asist')">+</button></th>`;
            if (trab.length) html += `<th colspan="${trab.length}" class="group-header"><span class="editable" onclick="editarLabel('labelTrabajos')">${config.labelTrabajos}</span> <button class="add-col-btn" onclick="mostrarModalColumnaRapida('trab')">+</button></th>`;
            if (trim.length) html += `<th colspan="${trim.length}" class="group-header"><span class="editable" onclick="editarLabel('labelTrimestres')">${config.labelTrimestres}</span> <button class="add-col-btn" onclick="mostrarModalColumnaRapida('trim')">+</button></th>`;
            if (cal.length) html += `<th colspan="${cal.length}" class="group-header"><span class="editable" onclick="editarLabel('labelCalificaciones')">${config.labelCalificaciones}</span> <button class="add-col-btn" onclick="mostrarModalColumnaRapida('cal')">+</button></th>`;
            if (otros.length) html += `<th colspan="${otros.length}" class="group-header"><span class="editable" onclick="editarLabel('labelOtros')">${config.labelOtros}</span> <button class="add-col-btn" onclick="mostrarModalColumnaRapida('otro')">+</button></th>`;
            html += '<th>Acciones</th></tr>';
            
            html += '<tr><th class="nombre-col"></th>';
            config.cols.forEach(col => {
                const bg = {white:'#e9ecef', yellow:'#fff9c4', green:'#c8e6c9'}[col.color];
                
                // Para columnas de asistencia, mostrar un selector de fecha
                if (col.tipo === 'asist') {
                    html += `<th style="background:${bg}; color:#333;">
                        <span class="editable" onclick="abrirSelectorFecha('${col.id}')" title="Haz clic para cambiar la fecha">üìÖ ${col.nom}</span>
                        <div class="color-selector">
                            <div class="color-btn" style="background:#fff; border:2px solid #999;" onclick="cambiarColor('${col.id}','white')" title="Blanco"></div>
                            <div class="color-btn" style="background:#fff9c4" onclick="cambiarColor('${col.id}','yellow')" title="Amarillo"></div>
                            <div class="color-btn" style="background:#c8e6c9" onclick="cambiarColor('${col.id}','green')" title="Verde"></div>
                        </div>
                        <button onclick="eliminarColumna('${col.id}')" title="Eliminar columna" style="background:#dc3545;color:white;border:none;border-radius:50%;width:18px;height:18px;font-size:11px;cursor:pointer;line-height:1;padding:0;margin-top:4px;display:block;margin-left:auto;margin-right:auto;">√ó</button>
                    </th>`;
                } else {
                    html += `<th style="background:${bg}; color:#333;">
                        <span class="editable" onclick="editarCol('${col.id}')">${col.nom}</span>
                        <div class="color-selector">
                            <div class="color-btn" style="background:#fff; border:2px solid #999;" onclick="cambiarColor('${col.id}','white')" title="Blanco"></div>
                            <div class="color-btn" style="background:#fff9c4" onclick="cambiarColor('${col.id}','yellow')" title="Amarillo"></div>
                            <div class="color-btn" style="background:#c8e6c9" onclick="cambiarColor('${col.id}','green')" title="Verde"></div>
                        </div>
                        <button onclick="eliminarColumna('${col.id}')" title="Eliminar columna" style="background:#dc3545;color:white;border:none;border-radius:50%;width:18px;height:18px;font-size:11px;cursor:pointer;line-height:1;padding:0;margin-top:4px;display:block;margin-left:auto;margin-right:auto;">√ó</button>
                    </th>`;
                }
            });
            html += '<th></th></tr>';
            thead.innerHTML = html;
        }
        
        function renderBody() {
            const tbody = document.getElementById('tbodyTabla');
            if (!alumnos.length) {
                tbody.innerHTML = '<tr><td colspan="100" style="padding:40px;text-align:center;color:#999">No hay alumnos registrados</td></tr>';
                return;
            }
            
            // Ordenar alumnos alfab√©ticamente por nombre
            const alumnosOrdenados = [...alumnos].sort((a, b) => {
                return a.nombre.localeCompare(b.nombre, 'es', { sensitivity: 'base' });
            });
            
            let html = '';
            alumnosOrdenados.forEach(alu => {
                html += `<tr><td class="nombre-cell" onclick="abrirFichaAlumno(${alu.id})" title="Haz clic para ver la ficha completa">${alu.nombre}</td>`;
                config.cols.forEach(col => {
                    const bg = {white:'#fff', yellow:'#fff9c4', green:'#c8e6c9'}[col.color];
                    const val = alu[col.id] !== undefined ? alu[col.id] : '';
                    if (col.tipo === 'asist') {
                        html += `<td style="background:${bg}"><input type="checkbox" class="asistencia-check" ${val?'checked':''} onchange="update(${alu.id},'${col.id}',this.checked)"></td>`;
                    } else {
                        const tipo = (col.tipo === 'trab' || col.tipo === 'otro') ? 'text' : 'number';
                        const w = (col.tipo === 'trab' || col.tipo === 'otro') ? '80px' : '50px';
                        html += `<td style="background:${bg}"><input type="${tipo}" class="cell-input" style="width:${w}" value="${val}" ${tipo==='number'?'min="1" max="10"':''} onchange="update(${alu.id},'${col.id}',this.value)"></td>`;
                    }
                });
                html += `<td><button class="btn-ia" onclick="IA_generarInforme(${alu.id})">ü§ñ Informe IA</button></td>`;
                html += `<td><button class="btn-danger" onclick="eliminar(${alu.id})">Eliminar</button></td></tr>`;
            });
            tbody.innerHTML = html;
        }
        
        function update(id, campo, valor) {
            const alu = alumnos.find(a => a.id === id);
            if (alu) {
                alu[campo] = valor;
                guardar();
            }
        }
        
        function eliminar(id) {
            if (confirm('¬øEliminar este alumno?')) {
                guardarConHistorial();
                alumnos = alumnos.filter(a => a.id !== id);
                guardar();
                render();
            }
        }
        
        function mostrarModalAlumno() {
            document.getElementById('modalAlumno').style.display = 'block';
            document.getElementById('inputAlumno').value = '';
            setTimeout(() => document.getElementById('inputAlumno').focus(), 100);
        }
        
        function agregarAlumno() {
            const nom = document.getElementById('inputAlumno').value.trim();
            if (!nom) {
                alert('Ingresa un nombre');
                return;
            }
            const alu = {
                id: Date.now(), 
                nombre: nom,
                // Campos de la ficha
                ficha: {
                    email: '',
                    telefono: '',
                    nacimiento: '',
                    direccion: '',
                    contactoNombre: '',
                    contactoTelefono: '',
                    notas: ''
                }
            };
            config.cols.forEach(col => {
                alu[col.id] = col.tipo === 'asist' ? false : '';
            });
            alumnos.push(alu);
            guardarConHistorial();
            render();
            cerrarModal('modalAlumno');
        }
        
        function mostrarModalColumna() {
            document.getElementById('modalColumna').style.display = 'block';
            document.getElementById('inputColumna').value = '';
            setTimeout(() => document.getElementById('inputColumna').focus(), 100);
        }
        
        function mostrarModalColumnaRapida(tipo) {
            document.getElementById('selectGrupo').value = tipo;
            actualizarPlaceholderColumna();
            mostrarModalColumna();
        }
        
        function actualizarPlaceholderColumna() {
            const tipo = document.getElementById('selectGrupo').value;
            const input = document.getElementById('inputColumna');
            const grupoNombre = document.getElementById('nombreColumnaGroup');
            
            if (tipo === 'asist') {
                input.placeholder = 'Se agregar√° con la fecha de hoy';
                input.value = '';
                grupoNombre.style.display = 'none'; // Ocultar el campo de nombre
            } else {
                grupoNombre.style.display = 'block';
                input.placeholder = tipo === 'trab' ? 'Ej: TP2, Examen' : 
                                   tipo === 'trim' ? 'Ej: 2¬∞, 3¬∞' : 
                                   tipo === 'cal' ? 'Ej: Di, Feb, CD' :
                                   tipo === 'otro' ? 'Ej: Observaciones, Conducta' :
                                   'Nombre de la columna';
            }
        }
        
        function agregarColumna() {
            const tipo = document.getElementById('selectGrupo').value;
            const nom = document.getElementById('inputColumna').value.trim();
            
            // Para asistencias no se requiere nombre
            if (tipo !== 'asist' && !nom) {
                alert('Ingresa un nombre');
                return;
            }
            
            guardarConHistorial();
            
            const nuevaCol = {
                id: tipo + Date.now(),
                nom: tipo === 'asist' ? new Date().toLocaleDateString('es-AR', {day: '2-digit', month: '2-digit'}) : nom,
                tipo: tipo,
                color: 'white'
            };
            
            // Encontrar la √∫ltima columna del mismo tipo
            const colsTipo = config.cols.filter(c => c.tipo === tipo);
            if (colsTipo.length > 0) {
                const ultimaTipo = colsTipo[colsTipo.length - 1];
                const idx = config.cols.findIndex(c => c.id === ultimaTipo.id);
                config.cols.splice(idx + 1, 0, nuevaCol);
            } else {
                config.cols.push(nuevaCol);
            }
            
            // Agregar campo a todos los alumnos
            alumnos.forEach(alu => {
                alu[nuevaCol.id] = tipo === 'asist' ? false : '';
            });
            
            guardar();
            render();
            cerrarModal('modalColumna');
        }
        
        function eliminarColumna(colId) {
            const col = config.cols.find(c => c.id === colId);
            if (!col) return;
            
            const nombreCol = col.tipo === 'asist' ? `Asistencia del ${col.nom}` : col.nom;
            
            if (!confirm(`¬øEliminar la columna "${nombreCol}"?\n\nSe borrar√°n todos los datos de esta columna en todos los alumnos.\n\nEsta acci√≥n se puede deshacer con el bot√≥n ‚Ü∂ Deshacer.`)) return;
            
            guardarConHistorial();
            
            // Eliminar columna de config
            config.cols = config.cols.filter(c => c.id !== colId);
            
            // Eliminar datos de todos los alumnos
            alumnos.forEach(alu => {
                delete alu[colId];
            });
            
            guardar();
            render();
        }
        
        function editarTitulo() {
            // No permitir editar desde aqu√≠ - solo desde pantalla inicial
            alert('üí° Para editar el nombre de la materia, vuelve a la pantalla inicial y usa el bot√≥n ‚úèÔ∏è junto al nombre de la materia.');
            return;
        }
        
        function editarSubtitulo() {
            editando = {tipo:'subtitulo'};
            document.getElementById('inputEditar').value = config.subtitulo;
            document.getElementById('modalEditar').style.display = 'block';
            setTimeout(() => {
                document.getElementById('inputEditar').focus();
                document.getElementById('inputEditar').select();
            }, 100);
        }
        
        function editarLabel(campo) {
            editando = {tipo:'label', campo:campo};
            document.getElementById('inputEditar').value = config[campo];
            document.getElementById('modalEditar').style.display = 'block';
            setTimeout(() => {
                document.getElementById('inputEditar').focus();
                document.getElementById('inputEditar').select();
            }, 100);
        }
        
        function editarCol(id) {
            const col = config.cols.find(c => c.id === id);
            if (!col) return;
            editando = {tipo:'col', id:id};
            document.getElementById('inputEditar').value = col.nom;
            document.getElementById('modalEditar').style.display = 'block';
            setTimeout(() => {
                document.getElementById('inputEditar').focus();
                document.getElementById('inputEditar').select();
            }, 100);
        }
        
        function abrirSelectorFecha(colId) {
            editando = {tipo:'colFecha', id:colId};
            
            // Poner la fecha de hoy por defecto
            const hoy = new Date().toISOString().split('T')[0];
            document.getElementById('inputFecha').value = hoy;
            
            document.getElementById('modalFecha').style.display = 'block';
            setTimeout(() => {
                document.getElementById('inputFecha').focus();
            }, 100);
        }
        
        function guardarFecha() {
            if (!editando || editando.tipo !== 'colFecha') return;
            
            const fechaInput = document.getElementById('inputFecha').value;
            if (!fechaInput) {
                alert('Por favor selecciona una fecha');
                return;
            }
            
            guardarConHistorial();
            
            // Convertir fecha a formato DD/MM
            const fecha = new Date(fechaInput + 'T00:00:00');
            const dia = String(fecha.getDate()).padStart(2, '0');
            const mes = String(fecha.getMonth() + 1).padStart(2, '0');
            const fechaFormateada = `${dia}/${mes}`;
            
            const col = config.cols.find(c => c.id === editando.id);
            if (col) {
                col.nom = fechaFormateada;
                guardar();
                render();
            }
            
            cerrarModal('modalFecha');
        }
        
        function editarNombreAlumno(id) {
            const alu = alumnos.find(a => a.id === id);
            if (!alu) return;
            editando = {tipo:'nombreAlumno', id:id};
            document.getElementById('inputEditar').value = alu.nombre;
            document.getElementById('modalEditar').style.display = 'block';
            setTimeout(() => {
                document.getElementById('inputEditar').focus();
                document.getElementById('inputEditar').select();
            }, 100);
        }
        
        function abrirFichaAlumno(id) {
            const alu = alumnos.find(a => a.id === id);
            if (!alu) return;
            
            // Asegurar que existe el objeto ficha
            if (!alu.ficha) {
                alu.ficha = {
                    email: '',
                    telefono: '',
                    nacimiento: '',
                    direccion: '',
                    contactoNombre: '',
                    contactoTelefono: '',
                    notas: ''
                };
            }
            
            // Guardar el ID del alumno que se est√° editando
            editando = {tipo: 'fichaAlumno', id: id};
            
            // Llenar el modal con los datos
            document.getElementById('nombreAlumnoFicha').textContent = 'üìã Ficha de ' + alu.nombre;
            document.getElementById('fichaNombreCompleto').value = alu.nombre || '';
            document.getElementById('fichaEmail').value = alu.ficha.email || '';
            document.getElementById('fichaTelefono').value = alu.ficha.telefono || '';
            document.getElementById('fichaNacimiento').value = alu.ficha.nacimiento || '';
            document.getElementById('fichaDireccion').value = alu.ficha.direccion || '';
            document.getElementById('fichaContactoNombre').value = alu.ficha.contactoNombre || '';
            document.getElementById('fichaContactoTelefono').value = alu.ficha.contactoTelefono || '';
            document.getElementById('fichaNotas').value = alu.ficha.notas || '';
            
            // Mostrar modal
            document.getElementById('modalFichaAlumno').style.display = 'block';
        }
        
        function guardarFichaAlumno() {
            if (!editando || editando.tipo !== 'fichaAlumno') return;
            
            const alu = alumnos.find(a => a.id === editando.id);
            if (!alu) return;
            
            // Actualizar el nombre
            const nuevoNombre = document.getElementById('fichaNombreCompleto').value.trim();
            if (nuevoNombre) {
                alu.nombre = nuevoNombre;
            }
            
            // Guardar todos los datos de la ficha
            alu.ficha = {
                email: document.getElementById('fichaEmail').value.trim(),
                telefono: document.getElementById('fichaTelefono').value.trim(),
                nacimiento: document.getElementById('fichaNacimiento').value,
                direccion: document.getElementById('fichaDireccion').value.trim(),
                contactoNombre: document.getElementById('fichaContactoNombre').value.trim(),
                contactoTelefono: document.getElementById('fichaContactoTelefono').value.trim(),
                notas: document.getElementById('fichaNotas').value.trim()
            };
            
            guardar();
            render(); // Actualizar la tabla para mostrar el nombre nuevo
        }
        
        // Funci√≥n de autoguardado con debounce
        let timeoutAutoGuardado = null;
        function autoGuardarFicha() {
            // Limpiar timeout anterior
            if (timeoutAutoGuardado) {
                clearTimeout(timeoutAutoGuardado);
            }
            
            // Guardar despu√©s de 500ms de inactividad
            timeoutAutoGuardado = setTimeout(() => {
                guardarFichaAlumno();
            }, 500);
        }
        
        function guardarEdicion() {
            const txt = document.getElementById('inputEditar').value.trim();
            if (!txt) {
                alert('El texto no puede estar vac√≠o');
                return;
            }
            
            guardarConHistorial();
            
            if (editando.tipo === 'titulo') {
                config.titulo = txt;
                document.getElementById('titulo').textContent = txt;
            } else if (editando.tipo === 'subtitulo') {
                config.subtitulo = txt;
                document.getElementById('subtitulo').textContent = txt;
            } else if (editando.tipo === 'label') {
                config[editando.campo] = txt;
            } else if (editando.tipo === 'col') {
                const col = config.cols.find(c => c.id === editando.id);
                if (col) col.nom = txt;
            } else if (editando.tipo === 'nombreAlumno') {
                const alu = alumnos.find(a => a.id === editando.id);
                if (alu) alu.nombre = txt;
            }
            
            guardar();
            render();
            cerrarModal('modalEditar');
        }
        
        function cambiarColor(id, color) {
            guardarConHistorial();
            const col = config.cols.find(c => c.id === id);
            if (col) {
                col.color = color;
                guardar();
                render();
            }
        }
        
        function cerrarModal(id) {
            document.getElementById(id).style.display = 'none';
        }
        
        function deshacer() {
            if (historial.length === 0) {
                alert('No hay cambios para deshacer');
                return;
            }
            
            const ultimo = historial.pop();
            config = JSON.parse(JSON.stringify(ultimo.config));
            alumnos = JSON.parse(JSON.stringify(ultimo.alumnos));
            
            guardar();
            
            document.getElementById('titulo').textContent = config.titulo;
            document.getElementById('subtitulo').textContent = config.subtitulo;
            render();
        }
        
        function resetearApp() {
            if (confirm('‚ö†Ô∏è ATENCI√ìN: Esto eliminar√° TODOS los datos (alumnos, columnas, configuraci√≥n) y volver√° a la configuraci√≥n inicial.\n\n¬øEst√°s seguro?')) {
                localStorage.clear();
                location.reload();
            }
        }
        
        function exportarCSV() {
            if (!alumnos.length) {
                alert('No hay datos');
                return;
            }
            let csv = config.labelNombre;
            config.cols.forEach(c => csv += ',' + c.nom);
            csv += '\n';
            
            // Ordenar alumnos alfab√©ticamente igual que en la tabla
            const alumnosOrdenados = [...alumnos].sort((a, b) => {
                return a.nombre.localeCompare(b.nombre, 'es', { sensitivity: 'base' });
            });
            
            alumnosOrdenados.forEach(alu => {
                csv += `"${alu.nombre}"`;
                config.cols.forEach(c => {
                    const v = alu[c.id];
                    csv += ',' + (c.tipo === 'asist' ? (v?'X':'') : `"${v}"`);
                });
                csv += '\n';
            });
            const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'registro_'+Date.now()+'.csv';
            link.click();
        }
        
        function exportarPDF() {
            if (!alumnos.length) {
                alert('No hay datos');
                return;
            }
            const {jsPDF} = window.jspdf;
            const doc = new jsPDF({orientation:'landscape'});
            doc.setFontSize(16);
            doc.text(config.titulo, 15, 15);
            doc.setFontSize(11);
            doc.text(config.subtitulo, 15, 22);
            
            const headers = [[config.labelNombre]];
            config.cols.forEach(c => headers[0].push(c.nom));
            
            // Ordenar alumnos alfab√©ticamente igual que en la tabla
            const alumnosOrdenados = [...alumnos].sort((a, b) => {
                return a.nombre.localeCompare(b.nombre, 'es', { sensitivity: 'base' });
            });
            
            const data = alumnosOrdenados.map(alu => {
                const row = [alu.nombre];
                config.cols.forEach(c => {
                    const v = alu[c.id];
                    row.push(c.tipo === 'asist' ? (v?'X':'') : v);
                });
                return row;
            });
            
            doc.autoTable({
                head: headers,
                body: data,
                startY: 28,
                styles: {fontSize: 7},
                headStyles: {fillColor: [102, 126, 234]}
            });
            
            doc.save('registro_'+Date.now()+'.pdf');
        }
        
        function resetearApp() {
            if (confirm('‚ö†Ô∏è ATENCI√ìN: Esto eliminar√° TODOS los datos (alumnos, columnas, configuraci√≥n) y volver√° a la configuraci√≥n inicial.\n\n¬øEst√°s seguro?')) {
                localStorage.clear();
                location.reload();
            }
        }
        
        // ========== FUNCIONES DE RESPALDO MANUAL ==========
        
        function descargarRespaldo() {
            const datos = {
                config: config,
                alumnos: alumnos,
                fecha: new Date().toISOString(),
                version: '1.0'
            };
            
            const json = JSON.stringify(datos, null, 2);
            const blob = new Blob([json], {type: 'application/json'});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'respaldo_registro_' + Date.now() + '.json';
            link.click();
            
            alert('‚úÖ Respaldo descargado correctamente.\n\nGuarda este archivo en un lugar seguro (Google Drive, Dropbox, etc.).');
        }
        
        function cargarRespaldo(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const datos = JSON.parse(e.target.result);
                    
                    if (!datos.config || !datos.alumnos) {
                        alert('‚ùå Archivo de respaldo inv√°lido');
                        return;
                    }
                    
                    if (confirm('‚ö†Ô∏è Esto reemplazar√° todos los datos actuales con los del respaldo.\n\n¬øContinuar?')) {
                        
                        // ‚úÖ GUARDAR ESTADO ACTUAL EN HISTORIAL ANTES DE CARGAR
                        historial.push({
                            config: JSON.parse(JSON.stringify(config)),
                            alumnos: JSON.parse(JSON.stringify(alumnos))
                        });
                        if (historial.length > MAX_HISTORIAL) {
                            historial.shift();
                        }
                        
                        config = datos.config;
                        alumnos = datos.alumnos;
                        
                        guardar();
                        
                        document.getElementById('titulo').textContent = config.titulo;
                        document.getElementById('subtitulo').textContent = config.subtitulo;
                        document.getElementById('btnDeshacer').disabled = false;
                        render();
                        
                        alert('‚úÖ Respaldo cargado correctamente\n\nSi cargaste el respaldo por error, pod√©s usar el bot√≥n ‚Ü∂ Deshacer para volver al estado anterior.');
                    }
                } catch (error) {
                    alert('‚ùå Error al cargar el respaldo: ' + error.message);
                }
            };
            reader.readAsText(file);
            
            // Limpiar el input
            event.target.value = '';
        }
        
        // ========== GOOGLE DRIVE ==========
        
        function conectarGoogleDrive() {
            alert(`üìã INTEGRACI√ìN CON GOOGLE DRIVE

OPCI√ìN 1 - Manual (Recomendado por ahora):
1. Haz clic en "üì• Descargar Respaldo"
2. Sube el archivo .json a tu Google Drive
3. Cuando necesites restaurar:
   - Descarga el archivo de Google Drive
   - Haz clic en "üì§ Cargar Respaldo"

OPCI√ìN 2 - Autom√°tica (Requiere configuraci√≥n):
Para habilitar sincronizaci√≥n autom√°tica con Google Drive:
1. Necesitas crear un proyecto en Google Cloud Console
2. Configurar las credenciales OAuth
3. Esto requiere conocimientos t√©cnicos

Por seguridad y simplicidad, usa OPCI√ìN 1.

¬øQuieres descargar un respaldo ahora?`);
            
            if (confirm('¬øDescargar respaldo ahora?')) {
                descargarRespaldo();
            }
        }
        
        // Auto-guardado cada 30 segundos
        setInterval(() => {
            if (alumnos.length > 0) {
                localStorage.setItem('autoguardado', new Date().toLocaleString());
            }
        }, 30000);
        
        // Advertencia antes de cerrar
        window.addEventListener('beforeunload', (e) => {
            if (alumnos.length > 0 && !localStorage.getItem('autoguardado')) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
        
        window.onclick = e => {
            if (e.target.classList.contains('modal')) {
                e.target.style.display = 'none';
            }
        };
        
        ['inputAlumno','inputColumna','inputEditar'].forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.addEventListener('keypress', e => {
                    if (e.key === 'Enter') {
                        if (id === 'inputAlumno') agregarAlumno();
                        else if (id === 'inputColumna') agregarColumna();
                        else if (id === 'inputEditar') guardarEdicion();
                    }
                });
            }
        });
        
        // ========== REGISTRO DEL SERVICE WORKER (PWA) ==========
        // Solo registrar si est√° en servidor propio, no en preview
        if ('serviceWorker' in navigator && !location.hostname.includes('claudeusercontent') && location.protocol !== 'file:') {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('Service Worker registrado');
                        setInterval(() => { registration.update(); }, 60 * 60 * 1000);
                    })
                    .catch(err => { console.log('SW error:', err); });
            });
        }
        
        // Detectar cuando la app se puede instalar
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Mostrar mensaje de instalaci√≥n despu√©s de 3 segundos
            setTimeout(() => {
                if (deferredPrompt && !localStorage.getItem('appInstalada')) {
                    mostrarMensajeInstalacion();
                }
            }, 3000);
        });
        
        // Detectar cuando la app fue instalada
        window.addEventListener('appinstalled', () => {
            localStorage.setItem('appInstalada', 'true');
            alert('üéâ ¬°App instalada correctamente!\n\nAhora puedes usarla sin internet desde tu pantalla de inicio.');
        });
        
        function mostrarMensajeInstalacion() {
            if (confirm('üì± ¬øQuieres instalar esta app en tu dispositivo?\n\n‚úÖ Funciona sin internet\n‚úÖ Acceso r√°pido desde inicio\n‚úÖ Experiencia de app nativa')) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('Usuario acept√≥ instalar');
                    }
                    deferredPrompt = null;
                });
            } else {
                localStorage.setItem('appInstalada', 'rechazada');
            }
        }


        // ========== SISTEMA DE GESTI√ìN DE M√öLTIPLES MATERIAS ==========
        
        let MM = {
            db: { titulo: 'SELECCIONA TU MATERIA', materias: {} },
            activa: null
        };
        
        // Reemplazar window.onload original
        const onloadOriginal = window.onload;
        // (contrase√±a manejada en script del head)
        
        window.onload = function() {
            ESC_cargarDB();
            ESC_renderizar();
            MM_init();
        };
        
        function MM_init() {
            MM_cargarDB();
            MM_migrarDatosAntiguos();
            // No mostrar pantalla de materias autom√°ticamente
            // Solo se muestra cuando se selecciona una escuela
        }
        
        function MM_cargarDB() {
            const t = localStorage.getItem('mm_titulo');
            const m = localStorage.getItem('mm_materias');
            if (t) MM.db.titulo = t;
            if (m) try { MM.db.materias = JSON.parse(m); } catch(e) {}
            document.getElementById('tituloPantallaInicio').textContent = MM.db.titulo;
        }
        
        function MM_guardarDB() {
            localStorage.setItem('mm_titulo', MM.db.titulo);
            localStorage.setItem('mm_materias', JSON.stringify(MM.db.materias));
        }
        
        function MM_migrarDatosAntiguos() {
            const cfg = localStorage.getItem('config');
            const alu = localStorage.getItem('alumnos');
            if (cfg && alu && Object.keys(MM.db.materias).length === 0) {
                try {
                    const id = 'mat_' + Date.now();
                    MM.db.materias[id] = {
                        nombre: 'Materia Migrada',
                        config: JSON.parse(cfg),
                        alumnos: JSON.parse(alu),
                        historial: JSON.parse(localStorage.getItem('historial') || '[]')
                    };
                    MM_guardarDB();
                    setTimeout(() => alert('‚úÖ Datos migrados a "Materia Migrada"'), 500);
                } catch(e) {}
            }
        }
        
        function MM_mostrarInicio() {
            const pi = document.getElementById('pantallaInicial');
            pi.classList.remove('oculto');
            pi.style.display = 'flex';
            document.getElementById('appPrincipal').style.display = 'none';
            document.getElementById('btnVolverMaterias').style.display = 'none';
            MM_renderMaterias();
        }
        
        function MM_renderMaterias() {
            const lista = document.getElementById('listaMateriasInicio');
            const ids = Object.keys(MM.db.materias);
            if (ids.length === 0) {
                lista.innerHTML = '<p style="text-align:center;color:#999;padding:20px;">No hay materias. Crea una nueva.</p>';
                return;
            }
            let html = '';
            ids.forEach(id => {
                const m = MM.db.materias[id];
                const cant = (m.alumnos || []).length;
                html += `<div class="item-materia" onclick="MM_abrirMateria('${id}')">
                    <div class="nombre-materia">${m.nombre}</div>
                    <div class="info-materia">
                        <span>üë• ${cant}</span>
                        <button onclick="event.stopPropagation();MM_editarNombre('${id}')" class="btn-accion-mat">‚úèÔ∏è</button>
                        <button onclick="event.stopPropagation();MM_eliminar('${id}')" class="btn-accion-mat eliminar">üóëÔ∏è</button>
                    </div>
                </div>`;
            });
            lista.innerHTML = html;
        }
        
        function MM_editarTituloInicio() {
            const nvo = prompt('Nuevo t√≠tulo:', MM.db.titulo);
            if (nvo && nvo.trim()) {
                MM.db.titulo = nvo.trim();
                document.getElementById('tituloPantallaInicio').textContent = MM.db.titulo;
                MM_guardarDB();
            }
        }
        
        function MM_nuevaMateria() {
            const nom = prompt('Nombre de la materia:', 'NOMBRE DE MATERIA');
            if (nom && nom.trim()) {
                const id = 'mat_' + Date.now();
                MM.db.materias[id] = {
                    nombre: nom.trim(),
                    config: {
                        titulo: nom.trim(), subtitulo: '',
                        labelNombre: 'Nombre y Apellido',
                        labelAsistencias: 'Asistencias',
                        labelTrabajos: 'Trabajos/Eval.',
                        labelTrimestres: 'Trimestres',
                        labelCalificaciones: 'Calificaciones',
                        labelOtros: 'Otros',
                        cols: [
                            {id:'a1', nom: new Date().toLocaleDateString('es-AR', {day:'2-digit',month:'2-digit'}), tipo:'asist', color:'white'},
                            {id:'tp1', nom:'TP/Eval', tipo:'trab', color:'white'},
                            {id:'t1', nom:'1¬∞', tipo:'trim', color:'white'},
                            {id:'cal1', nom:'CF', tipo:'cal', color:'white'},
                            {id:'otro1', nom:'Otro1', tipo:'otro', color:'white'}
                        ]
                    },
                    alumnos: [],
                    historial: []
                };
                MM_guardarDB();
                MM_renderMaterias();
            }
        }
        
        function MM_editarNombre(id) {
            const m = MM.db.materias[id];
            const nvo = prompt('Nuevo nombre:', m.nombre);
            if (nvo && nvo.trim()) {
                m.nombre = nvo.trim();
                m.config.titulo = nvo.trim();
                MM_guardarDB();
                MM_renderMaterias();
            }
        }
        
        function MM_eliminar(id) {
            const m = MM.db.materias[id];
            if (confirm(`¬øEliminar "${m.nombre}"?\n\n‚ö†Ô∏è Se perder√°n todos los datos.`)) {
                delete MM.db.materias[id];
                MM_guardarDB();
                MM_renderMaterias();
            }
        }
        
        function MM_abrirMateria(id) {
            MM.activa = id;
            const m = MM.db.materias[id];
            localStorage.setItem('config', JSON.stringify(m.config));
            localStorage.setItem('alumnos', JSON.stringify(m.alumnos));
            localStorage.setItem('historial', JSON.stringify(m.historial || []));

            document.getElementById('pantallaInicial').style.display = 'none';
            document.getElementById('pantallaEscuelas').style.display = 'none';

            const app = document.getElementById('appPrincipal');
            app.classList.remove('oculto');
            app.style.display = 'block';

            const btnVolver = document.getElementById('btnVolverMaterias');
            btnVolver.classList.remove('oculto');
            btnVolver.style.display = 'block';

            // Actualizar el t√≠tulo del header con el nombre de la materia
            document.getElementById('titulo').textContent = m.nombre;

            if (onloadOriginal) onloadOriginal();
            cargar();
            render();
        }
        
        function MM_volverAInicio() {
            if (MM.activa) {
                const m = MM.db.materias[MM.activa];
                try {
                    m.config = JSON.parse(localStorage.getItem('config') || '{}');
                    m.alumnos = JSON.parse(localStorage.getItem('alumnos') || '[]');
                    m.historial = JSON.parse(localStorage.getItem('historial') || '[]');
                    MM_guardarDB();
                } catch(e) {}
            }
            MM.activa = null;

            document.getElementById('appPrincipal').style.display = 'none';
            document.getElementById('btnVolverMaterias').style.display = 'none';

            MM_mostrarInicio();
        }
        
        // Guardar autom√°ticamente cada 10 seg
        setInterval(() => {
            if (MM.activa && MM.db.materias[MM.activa]) {
                try {
                    const m = MM.db.materias[MM.activa];
                    m.config = JSON.parse(localStorage.getItem('config') || '{}');
                    m.alumnos = JSON.parse(localStorage.getItem('alumnos') || '[]');
                    m.historial = JSON.parse(localStorage.getItem('historial') || '[]');
                    MM_guardarDB();
                } catch(e) {}
            }
        }, 10000);

        // ========== SISTEMA DE HORARIOS ==========
        var HOR = { db: { horarios: {} }, activo: null };

        function HOR_cargarDB() {
            var data = localStorage.getItem('doces_horarios_db');
            if (data) { try { HOR.db = JSON.parse(data); } catch(e) { HOR.db = { horarios: {} }; } }
        }

        function HOR_guardarDB() {
            localStorage.setItem('doces_horarios_db', JSON.stringify(HOR.db));
        }

        function HOR_mostrarPantalla() {
            HOR_cargarDB();
            document.getElementById('pantallaEscuelas').style.display = 'none';
            document.getElementById('pantallaHorarios').style.display = 'flex';
            HOR_renderizar();
        }

        function HOR_volverAEscuelas() {
            document.getElementById('pantallaHorarios').style.display = 'none';
            document.getElementById('pantallaEscuelas').style.display = 'flex';
        }

        function HOR_volverALista() {
            HOR_guardarDB();
            document.getElementById('pantallaTablaHorario').style.display = 'none';
            document.getElementById('pantallaHorarios').style.display = 'flex';
        }

        function HOR_renderizar() {
            var lista = document.getElementById('listaHorarios');
            var horarios = Object.values(HOR.db.horarios);
            if (horarios.length === 0) {
                lista.innerHTML = '<div class="sin-horarios">No hay horarios. Agreg√° uno nuevo.</div>';
                return;
            }
            var html = '';
            horarios.forEach(function(h) {
                html += '<div class="horario-item" onclick="HOR_abrirTabla(\'' + h.id + '\')">' +
                    '<div class="horario-item-nombre">üìÖ ' + h.nombre + '</div>' +
                    '<div class="horario-item-acciones">' +
                    '<button class="btn-editar-horario" onclick="event.stopPropagation();HOR_editarNombre(\'' + h.id + '\')">‚úèÔ∏è</button>' +
                    '<button class="btn-eliminar-horario" onclick="event.stopPropagation();HOR_eliminar(\'' + h.id + '\')">üóëÔ∏è</button>' +
                    '</div></div>';
            });
            lista.innerHTML = html;
        }

        function HOR_agregar() {
            var nombre = prompt('Nombre del horario:', 'Horario ' + (Object.keys(HOR.db.horarios).length + 1));
            if (!nombre || !nombre.trim()) return;
            var id = 'hor_' + Date.now();
            var celdas = {};
            for (var f = 0; f < 10; f++)
                for (var c = 0; c < 6; c++)
                    celdas[f + '_' + c] = '';
            HOR.db.horarios[id] = { id: id, nombre: nombre.trim(), celdas: celdas };
            HOR_guardarDB();
            HOR_renderizar();
        }

        function HOR_editarNombre(id) {
            var h = HOR.db.horarios[id];
            if (!h) return;
            var nvo = prompt('Nuevo nombre:', h.nombre);
            if (nvo && nvo.trim()) { h.nombre = nvo.trim(); HOR_guardarDB(); HOR_renderizar(); }
        }

        function HOR_eliminar(id) {
            var h = HOR.db.horarios[id];
            if (!h) return;
            if (!confirm('¬øEliminar "' + h.nombre + '"?')) return;
            delete HOR.db.horarios[id];
            HOR_guardarDB();
            HOR_renderizar();
        }

        function HOR_abrirTabla(id) {
            var h = HOR.db.horarios[id];
            if (!h) return;
            HOR.activo = id;
            // Inicializar estructura si no existe
            if (!h.titulos) h.titulos = ['Hora', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
            if (!h.filas) h.filas = ['1¬∞','2¬∞','3¬∞','4¬∞','5¬∞','6¬∞','7¬∞','8¬∞','9¬∞','10¬∞'];
            if (!h.numCols) h.numCols = 6; // columnas de contenido (sin contar la de hora)
            // Asegurar que celdas existan para todas las filas/cols
            for (var f = 0; f < h.filas.length; f++)
                for (var c = 0; c < h.numCols; c++)
                    if (!h.celdas[f+'_'+c]) h.celdas[f+'_'+c] = '';
            document.getElementById('tituloTablaHorario').textContent = 'üìÖ ' + h.nombre;
            document.getElementById('pantallaHorarios').style.display = 'none';
            document.getElementById('pantallaTablaHorario').style.display = 'flex';
            HOR_renderTabla();
        }

        function HOR_renderTabla() {
            var h = HOR.db.horarios[HOR.activo];
            if (!h) return;
            if (!h.titulos) h.titulos = ['Hora', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
            if (!h.filas)   h.filas   = ['1¬∞','2¬∞','3¬∞','4¬∞','5¬∞','6¬∞','7¬∞','8¬∞','9¬∞','10¬∞'];
            if (!h.numCols) h.numCols = 6;

            // Asegurar que titulos tenga suficientes columnas
            while (h.titulos.length < h.numCols + 1) h.titulos.push('Col ' + h.titulos.length);

            // ‚îÄ‚îÄ THEAD ‚îÄ‚îÄ
            var thead = document.getElementById('theadTablaHorario');
            var thHtml = '<tr>';
            for (var t = 0; t <= h.numCols; t++) {
                thHtml += '<th><input class="th-input" type="text" value="' + (h.titulos[t]||'').replace(/"/g,'&quot;') + '" oninput="HOR_actualizarTitulo('+t+',this.value)" placeholder="T√≠tulo"></th>';
            }
            // Bot√≥n + para agregar columna
            thHtml += '<th style="background:transparent;border:none;padding:4px;vertical-align:middle;text-align:center;"><button class="btn-add-col" onclick="HOR_agregarColumna()" title="Agregar columna">+</button></th>';
            thHtml += '</tr>';
            thead.innerHTML = thHtml;

            // ‚îÄ‚îÄ TBODY ‚îÄ‚îÄ
            var tbody = document.getElementById('tbodyTablaHorario');
            var html = '';
            for (var f = 0; f < h.filas.length; f++) {
                html += '<tr>';
                html += '<td class="hora-cell"><textarea class="hora-input" rows="3" oninput="HOR_actualizarFila('+f+',this.value)">' + (h.filas[f]||'').replace(/</g,'&lt;') + '</textarea></td>';
                for (var c = 0; c < h.numCols; c++) {
                    var val = (h.celdas[f+'_'+c] || '');
                    html += '<td><textarea class="celda-horario" rows="3" oninput="HOR_actualizarCelda('+f+','+c+',this.value)">' + val.replace(/</g,'&lt;') + '</textarea></td>';
                }
                html += '<td style="border:none;padding:2px;vertical-align:middle;text-align:center;"><button class="btn-del-row" onclick="HOR_eliminarFila('+f+')" title="Eliminar fila">‚úï</button></td>';
                html += '</tr>';
            }
            // Fila con bot√≥n + para agregar fila
            html += '<tr><td colspan="' + (h.numCols + 2) + '" style="border:none;padding:6px 4px;"><button class="btn-add-row" onclick="HOR_agregarFila()" title="Agregar fila">+</button></td></tr>';
            tbody.innerHTML = html;
        }

        function HOR_agregarFila() {
            var h = HOR.db.horarios[HOR.activo];
            if (!h) return;
            var f = h.filas.length;
            h.filas.push((f+1) + '¬∞');
            for (var c = 0; c < h.numCols; c++) h.celdas[f+'_'+c] = '';
            HOR_guardarDB();
            HOR_renderTabla();
        }

        function HOR_eliminarFila(fila) {
            var h = HOR.db.horarios[HOR.activo];
            if (!h || h.filas.length <= 1) return;
            h.filas.splice(fila, 1);
            // Rearmar celdas
            var newCeldas = {};
            for (var f = 0; f < h.filas.length; f++)
                for (var c = 0; c < h.numCols; c++)
                    newCeldas[f+'_'+c] = h.celdas[(f >= fila ? f+1 : f)+'_'+c] || '';
            h.celdas = newCeldas;
            HOR_guardarDB();
            HOR_renderTabla();
        }

        function HOR_agregarColumna() {
            var h = HOR.db.horarios[HOR.activo];
            if (!h) return;
            var c = h.numCols;
            h.numCols++;
            h.titulos.push('Col ' + (c+1));
            for (var f = 0; f < h.filas.length; f++) h.celdas[f+'_'+c] = '';
            HOR_guardarDB();
            HOR_renderTabla();
        }

        function HOR_actualizarTitulo(col, valor) {
            var h = HOR.db.horarios[HOR.activo];
            if (!h) return;
            if (!h.titulos) h.titulos = ['Hora', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
            h.titulos[col] = valor;
            HOR_guardarDB();
        }

        function HOR_actualizarFila(fila, valor) {
            var h = HOR.db.horarios[HOR.activo];
            if (!h) return;
            if (!h.filas) h.filas = ['1¬∞','2¬∞','3¬∞','4¬∞','5¬∞','6¬∞','7¬∞','8¬∞','9¬∞','10¬∞'];
            h.filas[fila] = valor;
            HOR_guardarDB();
        }

        function HOR_actualizarCelda(fila, col, valor) {
            var h = HOR.db.horarios[HOR.activo];
            if (h) { h.celdas[fila + '_' + col] = valor; HOR_guardarDB(); }
        }

        // ========== SISTEMA DE CALENDARIO ==========
        var CAL = { anio: 0, mes: 0, diaSeleccionado: null };

        function CAL_abrir() {
            var hoy = new Date();
            CAL.anio = hoy.getFullYear();
            CAL.mes  = hoy.getMonth();
            CAL.diaSeleccionado = null;
            document.getElementById('calPanelDia').style.display = 'none';
            CAL_renderizar();
            document.getElementById('modalCalendario').style.display = 'block';
        }

        function CAL_getEventos() {
            // Eventos guardados dentro de la materia activa
            if (!MM.activa || !MM.db.materias[MM.activa]) return {};
            var m = MM.db.materias[MM.activa];
            if (!m.calendario) m.calendario = {};
            return m.calendario;
        }

        function CAL_guardar() {
            MM_guardarDB();
            // Sincronizar con localStorage de la materia activa
            if (MM.activa && MM.db.materias[MM.activa]) {
                var m = MM.db.materias[MM.activa];
                localStorage.setItem('mm_materias', JSON.stringify(MM.db.materias));
            }
        }

        function CAL_mesAnterior() {
            CAL.mes--;
            if (CAL.mes < 0) { CAL.mes = 11; CAL.anio--; }
            CAL_renderizar();
        }

        function CAL_mesSiguiente() {
            CAL.mes++;
            if (CAL.mes > 11) { CAL.mes = 0; CAL.anio++; }
            CAL_renderizar();
        }

        function CAL_renderizar() {
            var meses = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
            document.getElementById('calTituloMes').textContent = meses[CAL.mes] + ' ' + CAL.anio;

            var eventos = CAL_getEventos();
            var hoy = new Date();
            var primerDia = new Date(CAL.anio, CAL.mes, 1).getDay(); // 0=dom
            var diasEnMes = new Date(CAL.anio, CAL.mes + 1, 0).getDate();

            var html = '<div class="cal-grid">';
            var nombres = ['Dom','Lun','Mar','Mi√©','Jue','Vie','S√°b'];
            nombres.forEach(function(n){ html += '<div class="cal-dia-nombre">' + n + '</div>'; });

            // Celdas vac√≠as al inicio
            for (var i = 0; i < primerDia; i++) html += '<div class="cal-dia vacio"></div>';

            for (var d = 1; d <= diasEnMes; d++) {
                var clave = CAL.anio + '-' + (CAL.mes+1) + '-' + d;
                var tieneEventos = eventos[clave] && eventos[clave].length > 0;
                var esHoy = (hoy.getFullYear()===CAL.anio && hoy.getMonth()===CAL.mes && hoy.getDate()===d);
                var esSel  = (CAL.diaSeleccionado === clave);
                var cls = 'cal-dia';
                if (tieneEventos) cls += ' marcado';
                else if (esHoy)   cls += ' hoy';
                if (esSel)        cls += ' seleccionado';
                html += '<div class="' + cls + '" onclick="CAL_seleccionarDia(' + d + ')">' + d + '</div>';
            }
            html += '</div>';
            document.getElementById('calGrid').innerHTML = html;
        }

        function CAL_seleccionarDia(d) {
            var clave = CAL.anio + '-' + (CAL.mes+1) + '-' + d;
            CAL.diaSeleccionado = clave;
            var meses = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
            document.getElementById('calDiaSeleccionado').textContent = d + ' de ' + meses[CAL.mes] + ' ' + CAL.anio;
            document.getElementById('calPanelDia').style.display = 'block';
            document.getElementById('calInputEvento').value = '';
            CAL_renderizarEventosDia();
            CAL_renderizar();
        }

        function CAL_renderizarEventosDia() {
            var eventos = CAL_getEventos();
            var lista = eventos[CAL.diaSeleccionado] || [];
            var html = '';
            lista.forEach(function(ev, idx) {
                html += '<div class="cal-evento-item">' +
                    '<span>' + ev + '</span>' +
                    '<button onclick="CAL_eliminarEvento(' + idx + ')" title="Eliminar">‚úï</button>' +
                '</div>';
            });
            if (!lista.length) html = '<div style="color:#aaa;font-size:12px;margin-bottom:6px;">Sin anotaciones para este d√≠a.</div>';
            document.getElementById('calListaEventos').innerHTML = html;
        }

        function CAL_agregarEvento() {
            var input = document.getElementById('calInputEvento');
            var texto = input.value.trim();
            if (!texto || !CAL.diaSeleccionado) return;
            var eventos = CAL_getEventos();
            if (!eventos[CAL.diaSeleccionado]) eventos[CAL.diaSeleccionado] = [];
            eventos[CAL.diaSeleccionado].push(texto);
            CAL_guardar();
            input.value = '';
            CAL_renderizarEventosDia();
            CAL_renderizar();
        }

        function CAL_eliminarEvento(idx) {
            var eventos = CAL_getEventos();
            if (!eventos[CAL.diaSeleccionado]) return;
            eventos[CAL.diaSeleccionado].splice(idx, 1);
            if (eventos[CAL.diaSeleccionado].length === 0) delete eventos[CAL.diaSeleccionado];
            CAL_guardar();
            CAL_renderizarEventosDia();
            CAL_renderizar();
        }

        // Permitir agregar con Enter
        document.addEventListener('DOMContentLoaded', function() {
            var inp = document.getElementById('calInputEvento');
            if (inp) inp.addEventListener('keypress', function(e){ if(e.key==='Enter') CAL_agregarEvento(); });
        });

        // ========== INFORME POR IA ==========
        var GEMINI_API_KEY = 'AIzaSyA7cIbmj_W4VMAr6j4sRbI7csqLQ-N3PLk';

        function IA_generarInforme(aluId) {
            var alu = alumnos.find(function(a){ return a.id === aluId; });
            if (!alu) return;

            document.getElementById('iaAlumnoNombre').textContent = 'üë§ ' + alu.nombre;
            document.getElementById('iaTexto').textContent = '';
            document.getElementById('iaLoading').style.display = 'block';
            document.getElementById('modalInformeIA').style.display = 'block';

            // Armar resumen de datos del alumno
            var resumen = '';
            config.cols.forEach(function(col) {
                var val = alu[col.id];
                if (val === undefined || val === '') return;
                var tipo = '';
                if (col.tipo === 'asist') tipo = 'Asistencia';
                else if (col.tipo === 'trab') tipo = 'Trabajo/Evaluaci√≥n';
                else if (col.tipo === 'trim') tipo = 'Trimestre';
                else if (col.tipo === 'cal')  tipo = 'Calificaci√≥n';
                else tipo = 'Otro';
                var valStr = (col.tipo === 'asist') ? (val ? 'Presente' : 'Ausente') : val;
                resumen += '- ' + col.nom + ' (' + tipo + '): ' + valStr + '\n';
            });

            var materia = config.titulo || 'la materia';
            var prompt = 'Sos un docente que debe escribir un breve informe de desempe√±o escolar en espa√±ol argentino, en primera persona del plural (usamos, observamos), de manera formal pero c√°lida. ' +
                'El informe es sobre el/la alumno/a llamado/a "' + alu.nombre + '" en la materia "' + materia + '".\n\n' +
                'Sus datos de desempe√±o son:\n' + resumen + '\n' +
                'Escrib√≠ un informe de 3 a 5 oraciones que resuma su desempe√±o, mencionando sus fortalezas y √°reas de mejora seg√∫n los datos. ' +
                'No uses listas, solo texto corrido. No incluyas el nombre de la materia entre comillas.';

            var url = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=' + GEMINI_API_KEY;

            fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }]
                })
            })
            .then(function(r){ return r.json(); })
            .then(function(data) {
                document.getElementById('iaLoading').style.display = 'none';
                var texto = '';
                try {
                    texto = data.candidates[0].content.parts[0].text;
                } catch(e) {
                    texto = '‚ùå No se pudo generar el informe. Revis√° tu conexi√≥n o la API key.';
                }
                document.getElementById('iaTexto').textContent = texto;
            })
            .catch(function(err) {
                document.getElementById('iaLoading').style.display = 'none';
                document.getElementById('iaTexto').textContent = '‚ùå Error al conectar con la IA: ' + err.message;
            });
        }

        function IA_copiar() {
            var texto = document.getElementById('iaTexto').textContent;
            if (!texto) return;
            navigator.clipboard.writeText(texto).then(function() {
                alert('‚úÖ Informe copiado al portapapeles');
            });
        }

    </script>
</body>
</html>